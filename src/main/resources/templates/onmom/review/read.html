<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<th:block th:replace="~{/layout/basic :: setContent(~{this::content})}">
    <th:block th:fragment="content">
        <!-- Page Content-->
        <section class="py-5 post_content">
            <div class="container px-5 my-5 review_post">
                <div class="row gx-5">
                    <div class="container-fluid">
                        <!-- 게시물 상세-->
                        <article>
                            <header class="mb-4">
                                <!-- 게시판 기본 타이틀 -->
                                <div class="board_title">
                                    <h1>추천 헬스장<span class="fw-light text-muted sub_title">회원 분들의 추천 게시판입니다.</span></h1>
                                </div>
                            </header>
                            <div class="post_info mb-4">
                                <!-- 게시글 제목-->
                                <h2 class="fw-bolder post_title">
                                    [[${dto.title}]]
                                </h2>
                                <hr />
                                <!-- 작성 정보-->
                                <div class="text-muted mb-2 post_detail">
                                    <div class="post_no col-3">
                                        <p class="mb-0 fw-bold text-dark">번호</p>
                                        <span name="review_id">
                                            [[${dto.review_id}]]
                                        </span>
                                    </div>
                                    <div class="post_area col-3">
                                        <p class="mb-0 fw-bold text-dark">지역</p>
                                        <span>
                                                [[${dto.area}]]
                                        </span>
                                    </div>
                                    <div class="post_wirte col-3">
                                        <p class="mb-0 fw-bold text-dark">작성자</p>
                                        <span>
                                                [[${dto.member_id}]]
                                        </span>
                                    </div>
                                    <div class="post_date col-3">
                                        <p class="mb-0 fw-bold text-dark">작성일</p>
                                        <span>
                                            [[${dto.regDate}]]
                                        </span>
                                    </div>
                                </div>
                                <hr />
                            </div>

                            <!-- 글 내용-->
                            <section class="mb-5">
                                <!-- 글 내용 관련 thymeleaf 코드는 p 태그 안에 기입 -->
                                <p class="fs-5 mb-4">
                                    <!-- 이미지 영역, div 태그로 작성되어 자동 줄바꿈, thumnail 관련 코딩 기입 -->
                                    <div>
                                        <ul>
                                            <li th:each="image: ${dto.imageDTOList}" th:data-file="${image.getThumbnailURL()}">
                                                <img th:if="${image.path != null}" th:src="|/display?fileName=${image.getThumbnailURL()}|">
                                            </li>
                                        </ul>
                                    </div>
                                    [[${dto.content}]]
                                </p>
                            </section>
                            <!-- 좋아요 싫어요 -->
                            <div class="like">
                                <div class="like_inner">
                                    <div>
                                        <img src="/img/like.png" alt="좋아요">
                                        <!-- like_cnt, default 값은 0으로 함 -->
                                        <span>[[${dto.like_cnt}]]</span>
                                    </div>
                                    <div>
                                        <img src="/img/dislike.png" alt="싫어요">
                                        <!-- dislike_cnt, default 값은 0으로 함 -->
                                        <span>[[${dto.hate_cnt}]]</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 수정 / 삭제 / 목록 버튼 -->
                            <div class="btn_wrap">
                                <button type="button" class="btn btn-dark btn_style">
                                    <a th:href="@{/review/modify(review_id = ${dto.review_id})}">
                                        수정
                                    </a>
                                    </button>
                                <button type="button" class="btn btn-dark btn_style">삭제</button>
                                <a href="/onmom/review/list"><button type="button" class="btn btn-dark btn_style">목록</button></a>
                            </div>
                        </article>
                        <hr />
                        <!-- 댓글 section 영역-->
                        <section>
                            <div>
                                <div class="card-body comment_area">
                                    <!-- 댓글 리스트 -->
<!--                                    <div class="d-flex mb-4">-->
<!--                                        &lt;!&ndash; Parent comment&ndash;&gt;-->
<!--                                        <div class="flex-shrink-0"><img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>-->
<!--                                        <div class="ms-3">-->
<!--                                            <div class="fw-bold"></div>-->
<!--                                            If you're going to lead a space frontier, it has to be government; it'll never be private enterprise. Because the space frontier is dangerous, and it's expensive, and it has unquantified risks.-->
<!--                                            &lt;!&ndash; Child comment 1&ndash;&gt;-->
<!--                                            <div class="d-flex mt-4">-->
<!--                                                <div class="flex-shrink-0"><img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>-->
<!--                                                <div class="ms-3">-->
<!--                                                    <div class="fw-bold">Commenter Name</div>-->
<!--                                                    And under those conditions, you cannot establish a capital-market evaluation of that enterprise. You can't get investors.-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                            &lt;!&ndash; Child comment 2&ndash;&gt;-->
<!--                                            <div class="d-flex mt-4">-->
<!--                                                <div class="flex-shrink-0"><img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>-->
<!--                                                <div class="ms-3">-->
<!--                                                    <div class="fw-bold">Commenter Name</div>-->
<!--                                                    When you put money directly to a problem, it makes a good headline.-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- Single comment-->
<!--                                    <div class="d-flex">-->
<!--                                        <div class="flex-shrink-0"><img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>-->
<!--                                        <div class="ms-3">-->
<!--                                            <div class="fw-bold">Commenter Name</div>-->
<!--                                            When I look at the universe and all the ways the universe wants to kill us, I find it hard to reconcile that with statements of beneficence.-->
<!--                                        </div>-->
<!--                                    </div>-->
                                </div>
                                <!-- 댓글 예시 끝 -->
                                <!-- 댓글 입력 창 감싸는 div -->
                                <div class="comment_write">
                                    <!-- 댓글 작성자 ID -->
                                    <div class="member_id_wrap">
                                        <b>
                                            <input type="hidden" name="member_id" th:value="${#authentication.name}" />
                                            <span class="checkId" name="member_id" sec:authentication="name">

                                            </span>
                                        </b>
                                    </div>
                                    <!-- 댓글 입력 창-->
                                    <!-- 스프링 시큐리티 인증이 됐을 경우 댓글 작성 가능 -->
                                    <th:block sec:authorize="isAuthenticated()">
                                        <form class="mb-4 comment_input">
                                            <textarea name="content" class="col-10 replyText" rows="3" placeholder="Join the discussion and leave a comment!"></textarea>
                                            <div class="submit_btn_wrap col-2">
                                                <button type="button" class="btn-dark btn_style_sq replyBtn">등록</button>
                                            </div>
                                        </form>
                                    </th:block>
                                    <th:block sec:authorize="isAnonymous()">
                                        <form class="mb-4 comment_input replyCant">
                                            <textarea name="content" class="col-10 replyText" rows="3" placeholder="Join the discussion and leave a comment!" readonly></textarea>
                                            <div class="submit_btn_wrap col-2">
                                                <button type="button" class="btn-dark btn_style_sq">등록</button>
                                            </div>
                                        </form>
                                    </th:block>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </section>
        <!-- 스프링 시큐리티 인증 됐을 경우, 댓글 작성 불가 관련 form 태그는 출력되지 않게 처리함 -->
        <th:block sec:authorize="isAuthenticated()">
            <style>
                .replyCant{display:none;}
            </style>
        </th:block>
        <script>
            $(function(){

                // 게시글 번호를 변수로 선언
                var review_id = [[${dto.review_id}]];
                var member_id = $('input[name="member_id"]').val();

                // 댓글 권한 알림창
                $(".replyCant").click(function(){
                    alert("로그인이 필요한 서비스입니다!");
                    location.href="/onmom/login";
                });

                // 댓글 등록
                $(".replyBtn").click(function(){
                    // 댓글 빈칸 checking
                    var checkContent = $(".replyText").val();

                    if(checkContent == ""){
                        alert("댓글 내용을 입력해 주세요!");
                        $(".replyText").focus();
                        return false;
                    }else{ // 댓글 내용 존재할 때 DB로 ajax 통해 전송
                        var reply = {
                            review_id : review_id,
                            content : $(".replyText").val(),
                            member_id : member_id
                        }

                        console.log(reply);

                        $.ajax({
                            url :'/reviews/'+review_id,
                            type : "POST",
                            data : JSON.stringify(reply),
                            contentType : "application/json; charset = utf-8",
                            dataType : "text",
                            success : function(result){
                                console.log("결과 : "+result);
                                self.location.reload();
                        }
                        ,
                        error:function(request,status,error){
                            console.log("CODE: "+request.status+"\n"+"message: "+request.responseText+"\n"+"error: "+error);
                        }
                    })
                    }


                }); // 댓글 등록 끝

                // 페이지가 열리면 바로 review 데이터를 가져와 사용
                function getReviewReplies(){
                    // 시간 checking
                    function formatTime(str){
                        var date =new Date(str);

                        return date.getFullYear() +'/'+
                        (date.getMonth() + 1) +'/'+
                        date.getDate() +' '+
                        date.getHours() +':'+
                        date.getMinutes();
                    }

                    $.getJSON("/reviews/"+ review_id +"/all", function(arr){
                        var str = "";

                        // reply 관련 태그 삽입
                        $.each(arr, function(idx, reply){
                         console.log(reply);

                         str += '<div class="d-flex mb-3">';
                         str += '<div class="ms-3">';
                         str += '<div class="fw-bold">'+reply.member_id+'</div>';
                         str += reply.content+'</div>';
                         str += '</div>';
                        });

                        $('.comment_area').html(str);

                    });
                }
                getReviewReplies();


            }) // window 선 업로드 끝
        </script>

    </th:block>
</th:block>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="/js/scripts.js"></script>
